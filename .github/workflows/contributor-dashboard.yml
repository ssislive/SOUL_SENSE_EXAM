name: Contributor Activity Dashboard

on:
  schedule:
    # Runs every day at midnight UTC
    - cron: "0 0 * * *"

  workflow_dispatch: # Allows manual trigger

permissions:
  issues: read
  pull-requests: read
  contents: write

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Contributor Dashboard
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1️⃣ Fetch open issues
            const openIssues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: "open", per_page: 100 }
            );

            // 2️⃣ Fetch PRs (open, merged, closed)
            const prs = await github.paginate(
              github.rest.pulls.list,
              { owner, repo, state: "all", per_page: 100 }
            );

            // 3️⃣ Collect contributors activity
            const contributorsMap = {};

            function addContributor(user, type) {
              if (!user) return;
              const login = user.login;
              if (!contributorsMap[login]) {
                contributorsMap[login] = { issues: 0, prs: 0 };
              }
              contributorsMap[login][type]++;
            }

            openIssues.forEach(issue => {
              if (!issue.pull_request) addContributor(issue.user, "issues");
            });

            prs.forEach(pr => addContributor(pr.user, "prs"));

            // 4️⃣ Build markdown content
            let md = `# Contributor Activity Dashboard\n\n`;
            md += `## Repository: ${owner}/${repo}\n\n`;
            md += `### Open Issues: ${openIssues.length}\n`;
            md += `### Total PRs: ${prs.length}\n\n`;

            md += `### Contributors Activity\n\n`;
            md += `| Contributor | Open Issues Created | PRs Created |\n`;
            md += `|------------|------------------|------------|\n`;
            for (const [login, activity] of Object.entries(contributorsMap)) {
              md += `| ${login} | ${activity.issues} | ${activity.prs} |\n`;
            }

            // 5️⃣ Save as Markdown file
            const filePath = 'CONTRIBUTOR_DASHBOARD.md';
            fs.writeFileSync(filePath, md);

            // 6️⃣ Commit changes
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: filePath,
              message: `Update contributor activity dashboard`,
              content: Buffer.from(md).toString('base64'),
              sha: (await github.rest.repos.getContent({ owner, repo, path: filePath })).data.sha
            });

            console.log("Contributor dashboard updated.");
